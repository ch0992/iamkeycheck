# app λ””λ ‰ν† λ¦¬ λ¬Έμ„ν™”

## π“‹ κ°μ”

`app` λ””λ ‰ν† λ¦¬λ” FastAPI κΈ°λ°μ μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…μ„ κµ¬μ„±ν•λ” ν•µμ‹¬ μ½”λ“κ°€ μ„μΉν• λ””λ ‰ν† λ¦¬μ…λ‹λ‹¤. 
μ΄ μ• ν”λ¦¬μΌ€μ΄μ…μ€ Uvicorn μ„λ²„λ¥Ό κΈ°λ°μΌλ΅ λΉ„λ™κΈ° μ²λ¦¬λ¥Ό μ§€μ›ν•λ©°, 
AWS IAM Access Keyμ μ‚¬μ© μƒνƒλ¥Ό λ¶„μ„ν•λ” κΈ°λ¥μ„ μ κ³µν•©λ‹λ‹¤.

## ν΄λ”/νμΌ κµ¬μ΅°

```
app/
β”β”€β”€ api/                    # API λΌμ°ν… μ •μ
β”‚   β”β”€β”€ routes/            # API μ—”λ“ν¬μΈνΈ λΌμ°ν…
β”‚   β””β”€β”€ secrets/           # AWS IAM Access Key CSV νμΌ μ €μ¥ μ„μΉ
β”β”€β”€ core/                  # IAM ν‚¤ λ¶„μ„ ν•µμ‹¬ λ΅μ§
β”β”€β”€ log/                   # λ΅κ·Έ μ„¤μ • λ° κ΄€λ¦¬
β”β”€β”€ services/              # λ„λ©”μΈ λ΅μ§ λ° μΈν„°νμ΄μ¤ κµ¬ν„
β”‚   β””β”€β”€ iamkeycheck/       # AWS IAM ν‚¤ λ¶„μ„ μ„λΉ„μ¤
β”β”€β”€ tests/                 # ν…μ¤νΈ μ½”λ“
β”‚   β”β”€β”€ test_api_stale_keys.py     # API ν…μ¤νΈ
β”‚   β”β”€β”€ test_csv_parsing.py        # CSV νμ‹± ν…μ¤νΈ
β”‚   β””β”€β”€ test_key_filtering.py      # ν‚¤ ν•„ν„°λ§ ν…μ¤νΈ
β””β”€β”€ util/                  # μ ν‹Έλ¦¬ν‹° λ¨λ“
    β””β”€β”€ extract_aws_creds.py       # AWS ν‚¤ μλ™ μ¶”μ¶
```

### μ£Όμ” ν΄λ” μ„¤λ…

1. **api/**
   - API λΌμ°ν… μ •μ λ° μΈμ¦ μ²λ¦¬
   - `/stale-keys` μ—”λ“ν¬μΈνΈ κµ¬ν„
   - IAM ν‚¤ μ •λ³΄ CSV νμΌ κ΄€λ¦¬

2. **services/**
   - λ„λ©”μΈ λ΅μ§ κµ¬ν„
   - AWS SDK μΈν„°νμ΄μ¤ κµ¬ν„
   - ν‚¤ λ¶„μ„ μ„λΉ„μ¤ κµ¬ν„

3. **secrets/**
   - AWS IAM Access Key CSV νμΌ μ €μ¥ μ„μΉ
   - κ¶μ¥ κ²½λ΅: `app/api/secrets/`
   - CSV νμΌ ν•μ‹:
     ```csv
     Access key ID,Secret access key
     {Access key ID},{Secret access key}
     ```

## π”„ λ¨λ“ νλ¦„

1. **API μ”μ²­ νλ¦„**
   1. ν΄λΌμ΄μ–ΈνΈκ°€ `/stale-keys?n=24` μ”μ²­
   2. FastAPI λΌμ°ν„°κ°€ μ”μ²­ μ²λ¦¬
   3. μ„λΉ„μ¤ λ μ΄μ–΄μ—μ„ IAM ν‚¤ λ¶„μ„
   4. AWS SDKλ¥Ό ν†µν• ν‚¤ μƒνƒ ν™•μΈ
   5. κ²°κ³Ό μ‘λ‹µ λ°ν™

2. **μ—λ¬ μ²λ¦¬ νλ¦„**
   - λ¨λ“  μ—λ¬λ” HTTPExceptionμΌλ΅ λ³€ν™
   - μƒμ„Έ μ—λ¬ λ΅κΉ…
   - ν΄λΌμ΄μ–ΈνΈ μΉν™”μ  μ—λ¬ λ©”μ‹μ§€

## π“ API μμ‹

### 1. `/stale-keys?n=24`

- **κΈ°λ¥**: Nμ‹κ°„ μ΄μƒ κ²½κ³Όλ AWS IAM Access Key μ΅°ν
- **μΏΌλ¦¬ νλΌλ―Έν„°**:
  - `n`: μ‹κ°„ κΈ°μ¤€ (κΈ°λ³Έκ°’: 24μ‹κ°„)
- **μ‘λ‹µ ν•μ‹**:
  ```json
  {
    "stale_keys": [
      {
        "user_id": "string",
        "access_key_id": "string",
        "created_time": "string"
      }
    ]
  }
  ```

## π“ ν…μ¤νΈ

### ν…μ¤νΈ λ²”μ„
- API ν…μ¤νΈ: `test_api_stale_keys.py`
  - `/stale-keys` μ—”λ“ν¬μΈνΈ ν…μ¤νΈ
  - μ”μ²­/μ‘λ‹µ κ²€μ¦
- CSV νμ‹± ν…μ¤νΈ: `test_csv_parsing.py`
  - AWS ν‚¤ CSV νμΌ νμ‹± ν…μ¤νΈ
  - λ°μ΄ν„° μ ν¨μ„± κ²€μ¦
- ν‚¤ ν•„ν„°λ§ ν…μ¤νΈ: `test_key_filtering.py`
  - ν‚¤ ν•„ν„°λ§ λ΅μ§ ν…μ¤νΈ
  - μ‹κ°„ κΈ°μ¤€ ν•„ν„°λ§ κ²€μ¦

## π“ λ΅κΉ…

### λ΅κΉ… μ„¤μ •
- **loguru**λ¥Ό μ‚¬μ©ν• λ΅κΉ… κµ¬ν„
- **νΉμ§•**:
  - μΌμλ³„ λ΅κ·Έ νμΌ μƒμ„±
  - λ΅κ·Έ λ λ²¨λ³„ ν•„ν„°λ§
  - μ—λ¬ μ¶”μ  μ •λ³΄ ν¬ν•¨
  - λΉ„λ™κΈ° λ΅κΉ… μ§€μ›

### λ΅κ·Έ νμΌ κµ¬μ΅°
```
logs/
β”β”€β”€ iamkeycheck_2025-05-18.log
β”β”€β”€ iamkeycheck_2025-05-19.log
β””β”€β”€ ...
```

### λ΅κ·Έ λ λ²¨
- **DEBUG**: μƒμ„Έ λ””λ²„κΉ… μ •λ³΄
- **INFO**: μΌλ°μ μΈ μ •λ³΄
- **WARNING**: κ²½κ³  λ©”μ‹μ§€
- **ERROR**: μ—λ¬ λ©”μ‹μ§€
- **CRITICAL**: μ‹¬κ°ν• μ—λ¬

## π›  μ‹¤ν–‰ μ „ μ”κµ¬μ‚¬ν•­

1. **ν™κ²½ λ³€μ μ„¤μ •**
   - `.env` νμΌμ—μ„ λ‹¤μ λ³€μλ¥Ό μ„¤μ •ν•΄μ•Ό ν•¨
   ```dotenv
   STAGE=dev
   CSV_PATH=app/api/secrets/
   LOG_LEVEL=INFO
   ```

2. **CSV νμΌ μ„μΉ**
   - `app/api/secrets/` λ””λ ‰ν† λ¦¬μ— CSV νμΌ μ €μ¥
   - `CSV_PATH` ν™κ²½ λ³€μλ΅ κ²½λ΅ μ§€μ • κ°€λ¥
   - CSV νμΌμ€ λ°λ“μ‹ Access key IDμ™€ Secret access key μ»¬λΌμ„ ν¬ν•¨ν•΄μ•Ό ν•¨

3. **λ΅κΉ… μ„¤μ •**
   - `LOG_LEVEL` ν™κ²½ λ³€μλ΅ λ΅κ·Έ λ λ²¨ μ„¤μ •
   - λ΅κ·Έλ” `logs/` λ””λ ‰ν† λ¦¬μ— μΌμλ³„λ΅ μƒμ„±λ¨
   - μ—λ¬ λ΅κ·Έλ” μλ™μΌλ΅ μ¶”μ  μ •λ³΄ ν¬ν•¨

## π§ μ£Όμμ‚¬ν•­

- AWS IAM Access Keyλ” λ―Όκ°ν• μ •λ³΄μ΄λ―€λ΅ μ•μ „ν• μ„μΉμ— μ €μ¥
- CSV νμΌμ€ `.gitignore`μ— ν¬ν•¨λμ–΄μ•Ό ν•¨
- λ΅κ·Έ νμΌμ€ μ •κΈ°μ μΌλ΅ λ°±μ—… λ° μ •λ¦¬ ν•„μ”
- λ¨λ“  μ—λ¬λ” λ΅κΉ…λλ©°, μƒμ„Έν• μ—λ¬ λ©”μ‹μ§€λ” λ΅κ·Έ νμΌμ—μ„ ν™•μΈ κ°€λ¥

## π›  μ ν‹Έλ¦¬ν‹°

### AWS ν‚¤ μλ™ μ¶”μ¶
- `util/extract_aws_creds.py`
  - AWS ν‚¤ CSV νμΌ μλ™ μ¶”μ¶
  - jqμ™€ python3 ν•„μ”
  - μλ™ ν™κ²½ λ³€μ μ„¤μ •
